## Artifact Registryにpushする際のimageについて

以下のような形式で記述する。

```
${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/rag-memo/image:${{ github.sha }}-${{ github.run_attempt }}
```

この際、REGIONに`asia-northeast1-a`を指定すると以下のエラーになる。

```
Error: buildx failed with: ERROR: error parsing HTTP 404 response body: invalid character '<' looking for beginning of value:
```

これは、`asia-northeast1-a`が使えない（Artifact Registryが利用可能なLocationとして存在しない）ために出るエラー。

利用可能なロケーションは以下の中から選択する。

https://cloud.google.com/artifact-registry/docs/repositories/repo-locations?hl=ja

この場合だと、`asia-northeast1`に変えると動く。

## GitHub Actions からのキーなしの認証の有効化（Workload Identityを用いた認証）

TODO: 記事にしたい。GitHub Actions からのGoogle Cloudへのキーなし認証を理解するまでの道のり
TODO: 腹落ちして完全に理解する。理解に時間をかける

### 概要
- これまではGitHub ActionsからGoogle CloudのArtifact Registryなどに認証する際にService Account Keyの発行が必要であった
- しかし、これは管理が複雑になるだけでなく、キーの漏洩リスクも孕んでいる
- そこで利用するのが、Workload Identity 連携（外部ワークロードのIDをGCPと連携する機能）を使用した GitHub Actions から Google Cloud への認証
- これは、GitHub が GitHub Actions ワークフローに OIDC トークンを導入したためできるようになった

### OIDC（OpenID Connect）について

処理の流れは以下の通り。2以降はGoogle Cloudの中の話になっている

1. GitHub Actions上でGitHub OIDCトークン発行サーバー（OIDC Provider）からGitHub OIDCトークン（正体はJWT）を発行する（OIDCトークンはshort-livedなどで漏洩してもリスクが低い）
2. 発行したOIDCトークン（外部 ID）をもとにSTS API（Security Token Service API）を叩き、STSトークンを入手する（このとき外部 ID はWorkload Identity Poolで編成・管理される）
    - Workload Identity Poolの作成と同時にPool Provider設定を追加する必要がある
    - Workload Identity Poolで管理するIDのプロバイダを指定・制限するため
3. STSトークンを使ってService Account Credentials APIを叩き、リソースへの権限を持つサービスアカウントのIDトークンを入手する（このとき、事前にリソースへの権限を持つService Accountは用意しておく必要がある）
4. 発行したサービスアカウントのIDトークンでリソースを操作する

### GitHub ActionsからWorkload Identityを用いたキーなし認証をする手順

[GitHub Actions で OIDC を使用して GCP 認証を行う](https://zenn.dev/kou_pg_0131/articles/gh-actions-oidc-gcp)

TODO: Gcloudコマンドは？

### 前にあった事例

Cloud Runのデプロイの順序は細かく分解すると以下のようになっている。

1. Github ActionsからGoogle CloudのサービスアカウントにOIDC（例えばa-github-actions@prj-hoge-p-8ad8.iam.gserviceaccount.com）
2. OIDC先のサービスアカウントでCloud Runのランタイムサービスアカウトになりすます（iam.serviceaccounts.actAs）（例えばhoge@prj-fuga-s-194f.iam.gserviceaccount.com）
3. Cloud Runをデプロイ

今回のケースだと「2」でOIDCアカウントがCloud Runのサービスアカウントになりすまそうとしてアカウントが存在しなかったためエラーになった。

### 参考資料

- [GitHub ActionsとGoogle CloudのOIDCの仕組みを理解する](https://zenn.dev/takamin55/articles/53d732b081ba66)
    - 分かりやすい..!
- [GitHub Actions からのキーなしの認証の有効化](https://cloud.google.com/blog/ja/products/identity-security/enabling-keyless-authentication-from-github-actions)
- [GitHub Actions: Secure cloud deployments with OpenID Connect](https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/)
- [GitHub ActionsでWorkload Identityでの認証を入れてGoogle CloudのAPIを叩く](https://zenn.dev/satohjohn/articles/1645be8e83eab6)
- [GitHub Actions で OIDC を使用して GCP 認証を行う](https://zenn.dev/kou_pg_0131/articles/gh-actions-oidc-gcp)
    - 今回はこれを参考にした
- [Google Cloud の Workload Identity 連携でGitHub Actionsから認証する](https://blog.lacolaco.net/posts/github-actions-oidc-google-cloud/)
- [GitHub Actions の OpenID Connect サポートについて](https://zenn.dev/miyajan/articles/github-actions-support-openid-connect)
