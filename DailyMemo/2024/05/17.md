## Node.js の --max-old-space-size について

参考: https://qiita.com/kawanet/items/cfedd535990b32710c50

ヒープのメモリ容量を設定するオプション。
デフォルト値は 1400MB。

```yml
command:
  - /nodejs/bin/node
args:
  - --max-old-space-size=512
  - dist/src/main
```

## Moment.jsとは？

JavaScriptで日付の処理は面倒ですが、いろいろと便利にしてくれるのが、Moment.js

参考: https://qiita.com/kyota/items/806da61fb8fffa34b695

## TSKaigi は配信画面も TypeScript 製だったという話

https://zenn.dev/ken7253/articles/tskaigi-streaming-layout

- `NodeCG` と呼ばれる `Node.js 向けの配信画面管理用のフレームワーク`を利用

## JavaScript のメモリについて分かりやすくまとめる

### 概要

C のような低水準言語には、malloc() や free() のような低水準のメモリー管理プリミティブがある。
つまり、メモリ管理をある程度手動でコントロールできる。

一方で JavaScript では、オブジェクトを作成するときにメモリーを自動的に確保し、使用しなくなったらメモリーを解放する。（`ガーベジコレクション`）

この`自動性`が混乱の元になる可能性がある。
メモリー管理について心配する必要がないという誤った印象を開発者に与える...

### メモリーライフサイクル

プログラミング言語に関係なく、メモリーのライフサイクルはほぼいつも同じ。

1. 必要なメモリーを割り当てる
2. 割り当てられたメモリーを使用する（読み込む, 書き込む）
3. 必要なくなったら、割り当てられたメモリーを解放する

2 に関してはすべての言語で明示的に行われる。

1 と 3 は低水準の言語では明示的だが、JavaScript のような高水準言語では、ほとんどの場合暗黙的に行われる。

### JavaScript での割り当て

#### 値の初期化

割り当てでプログラマーを悩まさないために、JavaScript では値を宣言したときと同時にメモリーの割り当ても行われる。

#### 関数呼び出しを介して割り当て

一部の関数呼び出しでは、オブジェクトの割り当てが発生する。

### 値の使用

値を使用することは、基本的に割り当てられたメモリーに読み書きすることを意味する。

これは変数やオブジェクトの値を読み書きすることや引数を関数に渡すことによって行われる。

### メモリーが不要になったときの解放

メモリー管理の問題のほとんどは、この段階に来る。

ここで最も難しい作業は、`割り当てられたメモリーが、必要とされなくなるときを見出すこと`。

プログラム内のどこで、そのようなメモリーの断片が不要になって解放する必要があるかを決定するには、開発者による判断が必要なことが多い。

一部の高水準言語、例えば JavaScript は、[`ガベージコレクション (GC)`](https://ja.wikipedia.org/wiki/%E3%82%AC%E3%83%99%E3%83%BC%E3%82%B8%E3%82%B3%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3) として知られる`自動メモリー管理`の方式を利用している。

ガベージコレクターの目的は、`メモリーの割り当てを監視し、割り当てられたメモリーのブロックができなくなったときに判断し、それを回収すること`。

特定のメモリーがまだ必要かどうかを判断する一般的な問題は[決定不能](https://ja.wikipedia.org/wiki/%E6%B1%BA%E5%AE%9A%E5%8F%AF%E8%83%BD%E6%80%A7)であるため、この自動処理は近似的なもの。

### ガベージコレクション

あるメモリーが「必要なくなった」かどうかを自動的に知るという普遍的問題は、決定不能。

そのため、ガベージコレクションのこの普遍的問題に対する解決策には制限がある。

この節では、`ガベージコレクションの主なアルゴリズムとその限界を理解するために必要な概念`を説明する。

### 参照

ガベージコレクションアルゴリズムが依存している主な概念は、参照 (reference) の概念。

メモリー管理の文脈では、あるオブジェクトが別のオブジェクトに（明示的にであれ、暗黙的にであれ）アクセスできるとき、前者が後者を参照していると言う。

例えば、JavaScript オブジェクトは自身の プロトタイプ（暗黙的な参照）とプロパティ値（明示的な参照）への参照を持つ。

ここでは、「オブジェクト」の概念は通常の JavaScript オブジェクトよりも広い概念として用いられており、また、関数のスコープ（もしくは、グローバルレキシカルスコープ）を含む。

### 参照カウントのガベージコレクション

※`現代のブラウザーで、ガベージコレクションに参照カウントを使用しているものはもうない`

最も素朴なガベージコレクションアルゴリズム。

このアルゴリズムは、`あるオブジェクトが必要なくなった`ことを、`あるオブジェクトがその他のオブジェクトから参照されていない`ことと定義する。

あるオブジェクトは、それに対する参照がゼロの時にガベージコレクション可能であると見なされる。

循環参照があると、制限がある。

参照するオブジェクトは、メモリーリークの一般的な発生させる原因。

### マークアンドスイープアルゴリズム

このアルゴリズムは、`あるオブジェクトが必要なくなった`ことを、`あるオブジェクトが到達不能である`ことと定義する。

このアルゴリズムは、`root` と呼ばれるオブジェクトの集合についての知識を前提としている（JavaScript では、root はグローバルオブジェクト）。

定期的に、ガベージコレクターは、これらの root から開始し、これらの root から参照されるすべてのオブジェクト、それから、これらの中から参照されるすべてのオブジェクトなどを見つける。

root から開始すると、ガベージコレクターは、すべての到達可能オブジェクトを見つけ、`すべての到達不能なオブジェクトをガベージコレクト`する。

`あるオブジェクトが参照を持たない`ということは、`そのオブジェクトは到達不能`であるということなので、`このアルゴリズムは前述のものよりも優れている`。循環で見たように、逆は正しくない。

現在、`すべての現代的なブラウザーでは、マークアンドスイープ式のガベージコレクターを持っている`。

`過去数年間で JavaScript のガベージコレクション（世代別/インクリメンタル/並行/並列ガベージコレクション）の分野で行われたすべての改善は、このアルゴリズムの実装の改善`であって、ガベージコレクションアルゴリズム自体に対する改善でも、「オブジェクトが必要とされなくなった」と扱う基準を変えるものでもありません。

しかし、`ガベージコレクションを手動で制御することができないのは変わらない`。

いつ、どんなメモリーを解放するかを手動で決めることができれば便利な時がある。

`オブジェクトのメモリーを解放するためには、明示的に到達できないようにする`必要がある。

また、`JavaScript ではプログラムによってガベージコレクションを発生させることはできない`。

エンジンがオプトインフラグで API を公開することはあっても、コア言語の中で発生することはない。

### 参考資料

- [MDN:メモリー管理](https://developer.mozilla.org/ja/docs/Web/JavaScript/Memory_management)
- 参考: https://qiita.com/tkdn/items/ea4f034e0d661def244a

## Node.js heap について

- heap 領域は大きく 2 種に分けられる
  - new space
    - この中もさらに 2 つ
      - from-space
        - オブジェクトが生成されるとここに置かれる
      - to-space
        - from-space が尽きると minorGC が動作し、生き残ったものはこちらに移動する
    - max-semi-space-size で設定
  - old space
    - minorGC を 2 回生き延びると、old-space へオブジェクトが移る
    - max-old-space-size で設定
  - ヒープ領域自体は全体メモリの半分割り当てられる模様
- GC について
  - minorGC
    - 比較的若い世代のオブジェクトのみを対象として削除
  - majorGC
    - すべてのデータを対象に削除
    - 遅い
- max-old-space-size の設定について
  - 2G のとき 1.5G 設定を推奨
  - デフォルト値は 1400MB とのこと
    - https://qiita.com/kawanet/items/cfedd535990b32710c50
    - ただし、マシンのメモリ量によって増減する