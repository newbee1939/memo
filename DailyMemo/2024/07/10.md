## コンテナのマルウェア対策の考え方

参考: https://www.trendmicro.com/ja_jp/business/tech_blog/c1_container_security_221107_03.html

- `Distrolessの活用`や`マルチステージビルド`で余計なものをイメージに含めない
- コンテナイメージの脆弱性スキャンを実施する
- スキャン済イメージや信頼するイメージのみを利用することを確実に
- `コンテナをRead Onlyで動作`
  - Cloud Runだと難しい？？

## rootユーザーでimageを作成しない（コンテナセキュリティ）

参考: https://qiita.com/Tsuyozo/items/c706a04848c3fbbaf055#root%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A7image%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%AA%E3%81%84

- dockerfileでUSERの指定を行い、non-rootユーザーの権限を与えるようにする
- USERの指定がないdockerfileから作られたコンテナに入ると、root権限をもつ状態になる
- そのようになった場合万が一コンテナに侵入された場合にroot権限を与えてしまうことになる
- またそのような事態になった場合に、コンテナを載せいているホストにも侵入される可能性も高まるので、コンテナはnon-rootなuserで起動させなければいけない

## .dockerignore アンチパターン

参考: https://qiita.com/munisystem/items/b0f08b28e8cc26132212

- .dockerignoreとは
  - Dockerfileからイメージをビルドする場合、Dockerfileの存在するディレクトリの中身はtarで固められdaemonへと送られる
  - このとき、imageに不要なファイルも送信するため、`ビルドに余計な時間がかかってしまう`
  - そこで .dockerignore の出番
  - .dockerignoreは.gitignoreのようにdockerで無視するファイルを指定することができるファイル
- `.dockerignoreによってビルドが遅くなる場合がある`
  - .dockerignore の実装は Go の filepath.Walk と Regexp.MatchString
  - つまり Dockerfile が存在するディレクトリをルートとして、ディレクトリをトラバースしながらファイル名が .dockerignore にマッチするかどうかを正規表現によって確認している処理によって実現している
  - これは`プロジェクトのファイル数（ベンダー含む）が多くなるに連れパフォーマンスが低下する`ということを表している
  - .gitignoreのように汎用的なものを列挙するのではなく、必要な物だけ記載するのが大事
  - また ! をつかわなくていいケースであれば追加しないようにする

## Distrolessイメージをroot以外のユーザーで実行する

- `COPY --chown=nonroot:nonroot USER nonroot` を使う
- 非rootユーザ対応は基本的には :nonroot にするだけで良いですが、マルチステージビルドの場合はbuilderステージで作成されたものはユーザを指定していない限りrootで作成されて実行できなくなってしまうのでCOPY時にchownオプションで `nonroot:nonroot` を指定してあげる必要がある

```dockerfile
FROM gcr.io/distroless/nodejs:14

WORKDIR /app

COPY --chown=nonroot:nonroot --from=build /app /app

USER nonroot
EXPOSE 3000
CMD ["dist/main"]
```

参考: https://zenn.dev/necocoa/articles/distroless-non-root
参考: https://cohalz.co/entry/2021/12/11/000000

## .dockerignore

- Docker CLI が コンテクスト・context （ Dockerfile や Docker イメージの中に送りたいファイルなど、Docker イメージ構築時に必要な素材・内容物のこと）を docker デーモンに送信する前に、コンテクストのルート・ディレクトリで .dockerignore という名前のファイルを探す
- このファイルが存在する場合、CLI はファイル内で書かれたパターンに一致するファイルやディレクトリを、コンテクストから除外する
- これにより、容量が大きいか機微情報を含むファイルやディレクトリを、不用意にデーモンに送信するのを回避したり、 ADD や COPY を使ってイメージに加えてしまうのも回避したりするのに役立つ

参考: https://docs.docker.jp/v20.10/engine/reference/builder.html#dockerignore

```dockerfile
FROM node:20.14.0-slim as builder

WORKDIR /usr/src/app

# NOTE: ビルド時にキャッシュが効くようnpm ciに必要なファイルだけ先にコピーする
COPY package.json package-lock.json ./

RUN npm ci

RUN ls && pwd

# ⭐️image内にはnode_modulesは存在しているが、ホストのnode_modulesは無視される
COPY . .

RUN ls && pwd

RUN npm run build && \
	npm ci --omit=dev

# v20.14.0
FROM gcr.io/distroless/nodejs20@sha256:1b210ce3c1983aca04be9647b073e494bb75f02902a3ad086537fab72807ee73

ENV TZ=Asia/Tokyo

WORKDIR /app

COPY --from=builder --chown=nonroot:nonroot /usr/src/app .

USER nonroot

ENTRYPOINT ["/nodejs/bin/node"]
CMD ["dist/src/main"]
```