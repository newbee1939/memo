---
marp: true
theme: gaia
class: invert
size: 16:9
style: |
  img[alt='center'] {
      display: block;
      margin: 0 auto;
  }
  strong,b {
    color: red;
  }
  h2 strong,b {
    color: red;
  }
---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 関数型ドメインモデリング

## 〜ドメイン駆動設計とF#でソフトウェアの複雑さに立ち向かおう〜

---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 第1部: ドメインの理解


---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 第1章: ドメイン駆動設計の紹介

---

## ソフトウェア開発者の仕事

- ❌ コードを書く
- ⭕️ ソフトウェアを使って問題を解決する

---

## 問題を解決するために必要なこと

- 問題を正しく「理解」する

---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

## 問題を理解するために必要なことは？

---

## ドメインエキスパート（問題を最もよく理解している人）と密接にコミュニケーションを取る

- ただ、これだけだとコードに対する「翻訳」作業が発生する
- 認識のズレにつながる...🤔

---

##  ドメインエキスパート・開発者・コードが同じメンタルモデルを共有する

- メンタルモデルをコードに直接反映する
- ドメインエキスパートからコードへの翻訳作業が発生しない
- 認識のズレも生まれにくい

=> ドメイン駆動設計が目指す状態！

---

## 共通のモデルを作成するために

- データ構造ではなく、ビジネスイベント（`ドメインイベント`）やワークフローに焦点を当てる
- ドメインをより小さなサブドメインに分割する
- 各サブドメインのモデルを解決空間に作成する
- プロジェクトに関わる全ての人が共有し、コードのあらゆる場所で使用される共通言語（`ユビキタス言語`）を開発する

---

## データ構造ではなく、ビジネスイベントやワークフローに焦点を当てる

- ビジネスは単にデータを`持って`いるだけでなく、何らかの方法でデータを`変換する`から
- ビジネスの価値は、この変換の過程で生み出されるため、これらの変換がどのように機能し、互いにどのように関係しているかを理解することは重要

---

## イベントストーミングでドメインを探索する

- ドメインの探索には`イベントストーミング`が有効
  - 「質問のある人と、答えられる人」を集める
- イベントストーミングで得られたイベント、コマンド、ビジネスワークフローを並べる
- このように、ビジネスプロセスを`入力と出力を持つパイプライン`として考える方法は、関数型プログラミングの仕組みと見事にマッチする

---

## ドメインをより小さなサブドメインに分割する

- 問題を小さくすることで解決しやすくする
- 小さくすることで役割が限定的になるので、ドメインとしても表現しやすい

---

## 各サブドメインのモデルを解決空間に作成する

- 「問題空間（現実世界）」と「解決空間（ドメインモデル）」を区別
- ドメインの必要な部分だけを取り出して解決空間に再作成
- 解決空間では、問題空間のドメインとサブドメインがDDD用語で`境界づけられたコンテキスト`と呼ばれるものにマッピングされる
- コンテキスト間の相互作用・全体像を把握するため`コンテキストマップ`を作成する

<!-- 「境界」を明確にしたコンテキストを定義することで、疎結合なシステムを構築できる -->

---

## プロジェクトに関わる全ての人が共有し、コードのあらゆる場所で使用される共通言語（ユビキタス言語）を開発する

- チームの全員が共有する概念と語彙のセット
- ビジネスドメインの共有メンタルモデルを定義する言語
- 全員がドメインに対して共通の理解を持つために必要

---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 第2章: ドメインの理解

---

## ドメインエキスパートへのインタビュー

- 自分のメンタルモデルをドメインに押し付けない
- 勝手な先入観を持たないことが重要
- 全てを受け入れる姿勢を持ち、自分の技術的な考えをドメインに押し付けない

---

## データベース駆動設計はしない

- `永続性非依存`
- データーベースの視点で設計をしていると、データベースモデルに合わせて設計を歪めてしまうことがある
- データベース駆動設計と同様、クラス駆動設計はしないようにする

---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 第3章: 関数型アーキテクチャ 

---

## 境界付けられたコンテキストのコミュニケーション 

- `イベント`を使って表現できる
- 完全に疎結合な設計
  - 上位のコンポーネントと下位のコンポーネントはイベントを通じてのみコミュニケーションを取る

---

## 境界付けられたコンテキスト間のデータ転送

- コンテキスト間のコミュニケーションに使用されるイベントは、単なる信号ではなく、下流のコンポーネントが処理するために必要な全てのデータを含む
- 上流のコンテキストの境界で、ドメインオブジェクトは`DTO（データ転送オブジェクト）`に変換される

---

## 信頼の境界線と検証

- 境界づけられたコンテキストの境界線は、`信頼の境界線`として機能する
- 境界付けられたコンテキストの外側にあるものは信頼されておらず、無効である可能性がある
- そのため、ワークフローの最初と最後に`ゲート`を追加し、信頼されたドメインと信頼されていない外の世界との間の仲介者として機能するようにする
- ゲートは`腐敗防止層（外部の異なるモデルによって自身のドメインモデルが腐敗するのを防ぐ）`の役割も果たすことが多い

---

## 境界付けられたコンテキスト間の契約

- 境界付けられたコンテキスト間でコミュニケーションを取るために、両者で契約をして共通フォーマットに同意する必要がある
- 誰が契約を決定するのか？
- DDDにおける関係を表す用語
  - `共有カーネル関係`
    - 2つのコンテキストが何らかの共通のドメイン設計を共有しているため、関係するチームが協力しなければならない場合
  - `顧客/供給者(コンシューマー駆動契約)`
    - 下流のコンテキストが上流のコンテキストに提供して欲しい契約を定義する
    - 上流のコンテキストが契約上の義務を果たす限り、2つのドメインは独立して発展できる
  - `順応者`
    - コンシューマー駆動とは逆
    - 下流のコンテキストは上流のコンテキストが提供する契約を受け入れ、それに合わせて自身のドメインモデルを調整する

--- 

## 境界づけられたコンテキストでのワークフロー

- ドメインの探索プロセスでは、ビジネスワークフローを、1つまたは複数のドメインイベントを生成するコマンドによって開始されるミニプロセスとして扱った
- 関数型アーキテクチャでは、これらのワークフローはそれぞれ1つの関数にマッピングされ、入力はコマンドオブジェクトであり、出力はイベントオブジェクトのリストになる

---

## 境界づけられたコンテキストの中のコード構造

- I/Oを端に追いやる
  - 関数型プログラミングの主な目的
    - 内部を見なくても、予測可能で理解しやすい関数を扱うこと
    - これを実現するために
      - 可能な限り不変のデータを扱う
      - 関数が隠れた依存関係ではなく、明示的な依存関係を持つようにする
      - 関数の副作用を避ける
        - e.g. ランダム性、関数の外にある変数の置き換え、あらゆる種類のI/O

---

<!--
_class:
  - lead
  - invert
_footer: ""
-->

# 第2部: ドメインのモデリング 

//

---

<!--
backgroundColor: black
footer: ""
-->

<!-- # TODO

- 再度読む
  - 腹落ちするまで読んで理解 -->
