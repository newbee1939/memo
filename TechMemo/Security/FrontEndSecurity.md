## 検証用リポジトリ

https://github.com/newbee1939/frontend-security

## HTTP基礎

- ブラウザは`HTTP`という通信規則に従ってサーバと通信をして、リソースの取得や作成、更新、削除を行う

## HTTPS

TODO: ハンズオンもする

実際にユーザーに提供するWebアプリケーションでは`必ず`HTTPSで通信をする。

### HTTPの弱点

- 通信データの盗聴が可能
- 通信相手のサーバが本物かわからない
- 通信内容の改ざんが可能

### HTTPの弱点を解決するTLS

- HTTPS = `HTTP over TLS`
- HTTPSは`TLS`という通信プロトコルを用いて、HTTPデータを暗号化して通信する仕組み
- HTTPデータをやりとりする前に`TLSハンドシェイク`と呼ばれる一連の手順によって暗号通信が確立される
- TLSを使った通信はHTTPの弱点を解消することができる
- 具体的には、TLSを使った通信では以下を実現する
    - 通信データの暗号化
    - 通信相手の検証
    - 通信データの改ざんチェック

### 通信データの暗号化

P48

- ブラウザとサーバがHTTP通信をする前に通信の暗号化をする
- 暗号化には鍵暗号方式が使われている
- ブラウザとサーバで秘密裏に交換した暗号鍵を使ってデータの暗号化と復号を行う
- 通信の暗号化には`公開鍵暗号方式`と`共通鍵暗号方式`という二つの暗号方式を使う
- 公開鍵暗号方式
    - データの暗号化に用いる共通鍵を安全に交換するために使う
    - 暗号鍵の受け渡しが楽
- 共通鍵暗号方式
    - HTTP通信でやりとりするデータの暗号化に使われる
    - 暗号化と復号が高速

### 通信相手の検証

- TLSでは、`電子証明書`を使って通信相手が本物か確認する
- 電子証明書は`認証局（CA）`と呼ばれる社会的に信頼されている機関によって発行される
- サーバーから送信された電子証明書はブラウザによって正しいかどうか検証され、あらかじめブラウザやOSの中に組み込まれている電子証明書と照合される
- もしCAから発行されていない電子証明書が使用されていると、ブラウザは`警告画面`を表示する

### HTTPS化の推進

新しいアプリを作るときにはhttpsにする

### Mixed Contentの危険性

- `Mixed Contents` = Webアプリケーション内に、HTTP通信で読み込んでいるリソースが混在している状態
    - ex. アプリ内のJavaScriptや画像などのサブリソースがHTTPで配信されている
- Mixed Contentsは解消する必要がある
- Mixed Contentsには2種類ある
    - `Passive mixed contents`
        - 画像、動画、音声ファイルといったリソースがHTTP
        - ブラウザで実行されるコードを含まないため危険度は低い
    - `Active mixed contents`
        - JSやCSSやブラウザ上でコードが実行されるリソースがHTTP
        - セキュリティ攻撃につながる可能性があるため危険

### HSTS（HTTP Strict Transport Security）を利用してHTTPS通信を強制する

- 既にhttpでリンクされてしまっている場合などに有効
- HSTSを有効にするには、レスポンスヘッダに`Strict-Transport-Security`ヘッダを付与する
- ブラウザは、`Strict-Transport-Security`ヘッダを受け取ると、それ以降のWebアプリケーションリクエストをHTTPSで行う
- `max-age`でHSTSを適用する時間を指定できる
    - `Strict-Transport-Security`ヘッダを利用する際には必須の設定
- `includeSubdomains`
    - サブドメにもHSTSを適用する
- `preload`
    - `HSTS Preload`という仕組みを利用
    - 初回のアクセスからHTTPS通信をさせる

## 🌟アプリケーション間でのアクセス制御の必要性🌟

例えば、ログインユーザーのみがユーザー情報を確認できるページ（login.html）があったとする。
このページを罠サイトのiframe内で読み込んだ場合、アクセス制限が全くないブラウザだと、以下の事象（事件）が発生する可能性がある

1. ユーザーが正規のサイトにログインしてlogin.htmlでユーザー情報を確認できる状態になっている
2. ユーザーが罠サイトにアクセスすることで、iframe内にユーザー情報（秘匿情報）が表示される
3. 罠サイト内のJSを使ってユーザーの情報が抜き取られる..

これを防ぐには、`他のWebアプリケーションが正規のサイトにアクセスするのを防ぐ`必要がある。

これを達成するのが、ブラウザに組み込まれている`同一オリジンポリシー(Same-Origin Policy)`

### 同一オリジンポリシー（Same-Origin Policy）による保護

- ブラウザに組み込まれているアクセス制限の仕組み
- 他のWebアプリケーションからのアクセスを制限する
- 異なるWebアプリケーションとの間に`オリジン（Origin）`という境界を設けて、Webアプリケーション間のアクセスを制限している

オリジンとは`スキーム名, ホスト名, ポート番号`の組み合わせを指す。
e.g. `https://example.com:443/path/tto/index.html`のオリジンは`https://example.com:443`となる

Webアプリケーションでは、オリジンが同じことを`同一オリジン（Same-Origin）`と呼び、オリジンが異なることを`クロスオリジン（Cross-Origin）`と呼ぶ。
`スキーム名, ホスト名, ポート番号`のいずれかが異なれば`クロスオリジン`になる。

ブラウザはデフォルトで同一オリジンポリシーを有効にしており、次のようなアクセスは制限されている。

- JSを使ったクロスオリジンへのリクエストの送信
    - アクセスするにはCORSの利用が必要
- JSを使ったiframe内のクロスオリジンページへのアクセス
    - `postMessage`関数を利用することで、クロスオリジンのiframeとの間でもデータのやり取りを行える
- クロスオリジンの画像を読み込んだ<canvas>要素のデータへのアクセス
- Web StorageやIndexedDB（ブラウザ組み込みのデータ保存機能）に保存されたクロスオリジンのデータへのアクセス