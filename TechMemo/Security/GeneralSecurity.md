## 検証用リポジトリ

https://github.com/newbee1939/wasbook-docker

## ボットネットワーク

- ボットとはマルウェアの一種で、外部からの指令を受けて、迷惑メール送信やDDos攻撃などの不正活動を行うもの
- 現役の攻撃手法の一つ

## 脆弱性が生まれる理由

- バグによるもの
- チェック機能の不足によるもの

## セキュリティガイドライン

- 安全なウェブサイトの作り方
    - https://www.ipa.go.jp/security/vuln/websecurity/about.html
- OWASP Top 10
    - https://owasp.org/Top10/ja/
    - Webアプリの最も重大なリスクのトップ10

## OWASP ZAPとは

- OWASP ZAP（OWASP Zed Attack Proxy）は、Webアプリケーション脆弱性診断用ツール
- OWASP ZAPはPC上でプロキシとして動作し、HTTP通信を観察したり、変更したりすることができる

## HTTP: レスポンスヘッダ

- 代表的なヘッダ
    - Content-Length
        - ボディのバイト数
    - Content-Type
        - `MIMEタイプ`というリソースの種類を指定
        - 以下のようなMIMEタイプがある
            - text/plain
            - image/gif
            - application/pdf

## Cookie: セキュリティを担保するためのセッションIDの要件

下記を守らないとなりすましが行われる可能性がある。

- 第三者がセッションIDを推測できないこと
    - 乱数の質が鍵
    - 開発ツールが提供するセッション管理機構を使う
- 第三者からセッションIDを強制されないこと
    - 認証後にセッションIDを変更する
- 第三者にセッションIDが漏洩しないこと

## 受動的攻撃

- Webアプリケーションにおける攻撃は、`受動的攻撃と`と`能動的攻撃`に分類される
- 能動的攻撃
    - 攻撃者がWebサーバーに対して直接攻撃すること
    - SQLインジェクションなど
- 受動的攻撃
    - 攻撃者がサーバーを直接攻撃するのではなく、Webサイトの利用者に罠を仕掛けることにより、罠を閲覧したユーザを通してアプリケーションを攻撃する手法

### 受動的攻撃の3パターン

- 正規サイトを悪用する受動的攻撃
    1. あらかじめ攻撃者が正規のサイトに罠を仕込む
    2. そのサイトを閲覧したユーザーが被害を受ける
- サイトをまたがった受動的攻撃
    1. 利用者が罠サイトを閲覧
    2. 罠サイトから、仕掛けを含むHTMLをダウンロードする
    3. HTMLの仕掛けが発動して正規サイトに攻撃のリクエストを送信
    4. 正規サイトからJavaScriptなどの仕掛けを含むレスポンスが返る

### ブラウザはどのように受動攻撃を防ぐか

#### サンドボックス

- ブラウザ上ではJavaScriptなどを実行できる
- 利用者のブラウザ上で悪意のあるプログラムが動かないよう、JavaScriptなどは安全性を高めるための機能を提供している
- 基本的な考え方は以下の二つ
    1. 利用者に配布元を確認させた上で、利用者が許可した場合のみ実行する
        - あまり使われていない
    2. プログラムの「できること」を制限するサンドボックスという環境を用意する
        - ローカルファイルへのアクセスの禁止
        - プリンタなどの資源の利用禁止
        - ネットワークアクセスの制限

#### 同一オリジンポリシー（same origin policy）

P77

- 受動的攻撃に対するブラウザの防御戦略の一つ
- `JavaScriptなどのクライアントスクリプトからサイトをまたがったアクセスを禁止する`セキュリティ上の制限
    - サンドボックスの機能の一つ
- ブラウザは、一度に複数のサイトのオブジェクトを扱うことができる
    - タブやiframeなどがその代表的な手段
- 同一オリジンである条件
    - URLのホストが一致している
    - スキーム（プロトコル）が一致している
    - ポート番号が一致している

## ⭐️CORS(Cross-Origin Resource Sharing)⭐️

- WebアプリにおいてJavaScriptの活用が進むようになると、同一オリジンポリシーの制限を超えて、サイト間でデータをやり取りしたいというニーズが強くなった
- そのため、HMLHttpRequestなどいくつかの局面について`サイトを超えてデータをやり取りできる仕様`として`CORS`が策定された
- CORSは従来の同一オリジンポリシーに依存するアプリケーションとの互換性を保ちながら、異なるオリジンとのデータ交換を可能にする

### シンプルなリクエスト

- 特定の条件を満たす`シンプルなリクエスト`の場合、異なるオリジンに相手側の許可なしにHTTPリクエストを送ることが可能
- ただ、リクエストは送信されるが、レスポンスを表示する際にエラーになる
    - `理由: CORSヘッダ 'Access-Control-Allow-Origin'が足りない`
- これに対処するのが以下のヘッダ（Access-Control-Allow-Origin）の付与

### Access-Control-Allow-Origin

- `Access-Control-Allow-Origin`はクロスオリジンからの読み出しを許可するための仕掛け
- 情報の提供元がHTTPレスポンスヘッダとして出力する
- `http://example.jp`に対してHMLHttpRequestなどのアクセスを許可する場合は下記のHTTTPレスポンスヘッダを送信する
    - Access-Control-Allow-Origin: http://example.jp
- これにより、異なるオリジンからのレスポンスをJavaScriptから参照できるようになる

### プリフライトリクエスト

- クロスオリジンアクセスにおいて`シンプルなリクエスト`の条件を満たさない場合、ブラウザは、`プリフライトリクエスト`というHTTPリクエストを送信する
- `プリフライトリクエスト`をクリアした上で、`Access-Control-Allow-Origin`を含むレスポンスを返却する必要がある

### 認証情報を含むリクエスト

- デフォルトでは、クロスオリジンに対するリクエストにはHTTP認証やクッキーなどの認証に用いられるリクエストヘッダは自動的に送信されない
- これを用いるには、`XMLHttpRequest`のプロパティ`withCredential`をtrueにする必要がある
- さらに、`Access-Control-Allow-Credential: true`というレスポンスヘッダを返す必要がある

### CORSまとめ

TODO: LT資料とか記事にして整理したい

- ブラウザの同一オリジンポリシー 
    - 通常は異なるオリジンにはアクセスできない
    - CORSによる異なるオリジン間のアクセスも可能
        - シンプルなリクエストの場合
            - `Access-Control-Allow-Origin`の付与で異なるオリジン間のアクセスが可能
        - シンプルなリクエストでない場合
            - `プリフライトリクエスト`と`Access-Control-Allow-Origin`で異なるオリジン間のアクセスが可能
        - 認証を含むリクエストの場合
            - `XMLHttpRequest`のプロパティ`withCredential`をtrueに
            - `Access-Control-Allow-Credential: true`というレスポンスヘッダを返す

## 入力処理とセキュリティ

- アプリがリクエストを受け取って実際の処理に入る前にすべきこと
    - 文字エンコーディングの妥当性検証
        - 文字コードを使った攻撃手法があるため
    - 文字エンコーディングの変換（必要な場合のみ）
        - HTTPメッセージとプログラム内部の文字エンコーディングが異なる場合
    - `入力値（パラメータ文字列）の妥当性検証`
        - セキュリティ上の要求というよりは、アプリケーションの仕様に基づいて行うもの
