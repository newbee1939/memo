## 負荷試験の概要

- 負荷試験は、実際に発生し得るシステムへのアクセス等を想定した負荷がかけ、それに耐えられるか等を確認する試験
- `大量のアクセスがかかった場合`や、`長時間連続稼働し続けた場合`にシステムに異常が発生しないか等を検証する

## 負荷テストの目的

1. 各種ユースケースの応答性能を推測する
2. 高負荷時の性能改善を行う
3. 目的の性能を提供することができるハードウェアをあらかじめ選定する
4. システムがスケール性を持つことを確認する
5. システムのスケール特性（「どの部分を増強すれば性能がどれだけ上がるか」という性質）を把握する

## サービスの性質によって負荷テストのやり方は異なる

- 大きく分けて`シナリオテストが必要かどうか`によって、やり方や使用するツールが変わってくる

## 負荷テストツールの選定

- k6 はGrafana Labsが開発している負荷テストツールおよびSaaS

## 負荷テストの流れ

負荷テストのアプローチと目的。

- 性能テスト：システムが想定している負荷に対し、どの程度のスループットやレイテンシかを確認する
- 限界テスト：処理限界に近い、または超過した負荷に対し、エラーが出るかなど、挙動を確認する
- 耐久テスト：長時間負荷をかけた際の挙動を確認する

負荷テストの流れ。（シナリオがあるパターン）

1. 負荷テスト計画書の作成
2. 負荷テスト環境の構築・負荷テスト対象のスペックを最低限に変更
3. ダミーデータ作成
4. 負荷テスト環境と負荷テストツールの検証
5. 単一エンドポイントに対するテスト
6. オートスケールを有効にした場合のテスト
7. シナリオテスト
8. 耐久テスト

5から7に関しては、起動クライアント数を徐々に上げ、負荷を上げていくことでスループットが限界となる負荷を探索していくので、性能テストと限界テストを兼ねている。

## 負荷試験をする「前」に考えること

何を測定する？

参考: https://speakerdeck.com/fujiwara3/k6niyorufu-he-shi-yan-ru-men-karashi-jian-made?slide=4

### ゴールを決める

- レイテンシ（レスポンスタイム）が目標？
  - どのレスポンスを何秒で返せればOKなのか
  - 平均値？中央値？P99？max?
  - そのレイテンシが保てる最大の並列アクセス数は？
- スループット（単位時間内に処理できるリクエスト数）が目標？
  - レイテンシ要件はない？
    - レイテンシ1secで1000並列
    - レイテンシ10secで10000並列（どちらも1000req/sec）
- あるサーバーリソースでのxxの最大化が目標

### その試験で測りたいものを言語化する

- レイテンシ
- スループット
- サーバーリソースの利用率・利用量（コストも含む）
  - 運用中に実際に起きるどのような状況で、これらの数値目標を達成するのか
  - e.g.
    - 状況: Push通知から〇〇分以内に〇〇人のユーザーがアプリを起動する
    - シナリオ: アプリが起動してホーム画面に遷移するときに発生するAPIアクセス
    - 目標: 平均レイテンシ250msec, P99 2Sec, サーバーエラーなし

### 負荷をかける対象のサーバーリソースは（できるだけ）固定する

- AutoScaling的なものを止めておく
- 負荷試験には`変数`が多い
  - e.g. シナリオ（測定対象URL）、リクエストの送信レート、並列度、、、
- 固定できないものは、せめてそのサイズ（キャパシティ）を同時に記録しておく

## スループットとレイテンシ（応答時間）

- スループット
  - 単位時間当たりの処理能力やデータ転送量のこと
  - `１秒間に処理を行うHTTPリクエストの数`
- レイテンシ
  - 転送要求を出してから実際にデータが送られてくるまでに生じる通信の遅延時間のこと
  - `アプリケーションの処理時間によって遅延した時間`

## 負荷テストの進め方

1. スループットの限界値を見つける
2. 負荷をかけてボトルネックを探す
3. チューニングをする
4. 改善したかを確認する

## 負荷試験で見るべきメトリクスやツール

- ⭐️Google Cloudの`Query Insights`
  - クエリのボトルネックを探せる

## ⭐️現実のパターンを想定してテストシナリオを作る

- e.g. 
  - 一定のリクエストを送り続ける
  - リクエストのを急激にスパイクさせる
- アクセスログから既存のリクエストの割合を読み取ってテストする
  - e.g. このエンドポイントに対するリクエストは10%、このエンドポイントに対するリクエストは50% みたいな

## 負荷試験中に気を付けること

- `負荷は5分以上掛ける`
  - メトリクスの解像度が1分の場合、実行開始と終了時を除いた3分間のメトリクスしか信用できない
- `エラー率/レイテンシが目標に達しない場合、並列度を増やさない`
  - 大抵状況は悪化するので時間の無駄
  - 常に「目標」を意識して負荷を与える、結果を評価する
- `ベンチマーカーがボトルネックになっていないか気をつける`
  - シナリオが重い、ツールが速くない場合、クライアントが先に根を上げる

## 参考

- [1ヶ月で負荷テストの基礎から学んで実際にやってみた知見](https://engineering.dena.com/blog/2021/10/healthcare-load-testing/)
- 達人が教えるWebパフォーマンスチューニング〜ISUCONから学ぶ高速化の実践
- [k6による負荷試験 入門から実践まで](https://speakerdeck.com/fujiwara3/k6niyorufu-he-shi-yan-ru-men-karashi-jian-made)

## めも
