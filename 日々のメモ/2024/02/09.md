## 読む人を意識した日報にする

TODO: ブログにも追記。意識すべき。文章力を高めるためにも

## Cloud RunのURlに直接アクセスできないようにする方法

```yml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  annotations:
    run.googleapis.com/ingress: INGRESS
  name: SERVICE
spec:
  template:
    metadata:
      name: REVISION
```

- `run.googleapis.com/ingress`に以下のいずれかを設定できる
  - all
  - internal
  - internal-and-cloud-load-balancing
- all以外を設定することで、Cloud RunのURLに直接アクセスされるのを防ぐことができる
- セキュリティ対策、およびDos攻撃を予防する（Dos攻撃のポイントを減らす）ためにも設定しておいた方が良い

参考: Cloud Run での上り（内向き）の制限（https://cloud.google.com/run/docs/securing/ingress?hl=ja）

## Shell Scriptに実行権限を付ける

参考: https://qiita.com/ntkgcj/items/6450e25c5564ccaa1b95

すべてのユーザーに実行権限を与える設定↓

```
chmod +x ./script.sh
```

これにより、以下のようなコマンドでシェルスクリプトを実行できるようになる。

```shell
./migration.sh
```

## Could not open input file: artisan解決方法

現在いるディレクトリに`artisan`ファイルが無いのが原因。

Dockerfileで管理しているコンテナ内で、対象のディレクトリに移動する場合は以下のように。

```dockerfile
WORKDIR /var/www/app

COPY . .
```

## GitHub ActionsのCloud Run Jobsのデプロイのところでエラー

```
ERROR: (gcloud.beta.run.jobs.update) PERMISSION_DENIED: Permission 'iam.serviceaccounts.actAs' denied on service account hoge@prj-fuga-s-194f.iam.gserviceaccount.com (or it may not exist).
```

`hoge@prj-fuga-s-194f.iam.gserviceaccount.com`が存在しないのが原因。

TODO: Cloud Runのデプロイの流れを理解したい

Cloud Runのデプロイの順序は細かく分解すると以下のようになっている。

1. Github ActionsからGoogle CloudのサービスアカウントにOIDC（例えばa-github-actions@prj-hoge-p-8ad8.iam.gserviceaccount.com）
2. OIDC先のサービスアカウントでCloud Runのランタイムサービスアカウトになりすます（iam.serviceaccounts.actAs）（例えばhoge@prj-fuga-s-194f.iam.gserviceaccount.com）
3. Cloud Runをデプロイ

今回のケースですと「2」でOIDCアカウントがCloud Runのサービスアカウントになりすまそうとしてアカウントが存在しなかったためエラーになった。

参考: GitHub Actions からのキーなしの認証の有効化（https://cloud.google.com/blog/ja/products/identity-security/enabling-keyless-authentication-from-github-actions）
